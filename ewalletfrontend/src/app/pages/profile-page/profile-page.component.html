<app-header></app-header>

<div class="flex bg-neutral-50 dark:bg-neutral-900 min-h-screen pt-16">
  <div class="flex-1 flex flex-col overflow-hidden">
    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-neutral-50 dark:bg-neutral-900 p-6">
      <div class="container mx-auto h-[calc(100vh-140px)] flex flex-col">
        <h1 class="text-3xl font-bold mb-6 text-neutral-800 dark:text-neutral-100">Profile</h1>

        <!-- Basic Profile Information -->
        <div class="bg-white dark:bg-neutral-800 rounded-lg shadow-md p-8 mb-8">
          <div *ngIf="!isEditing">
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Full Name:</strong> {{ user?.firstName }} {{ user?.lastName }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Email:</strong> {{ user?.email }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Phone:</strong> {{ user?.phone }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Role:</strong> {{ user?.role }}</p>
          </div>

          <!-- Editable Profile Form -->
          <form *ngIf="isEditing" [formGroup]="profileForm" (ngSubmit)="saveProfile()">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-neutral-700 dark:text-neutral-300 text-sm font-bold mb-2">First Name</label>
                <input
                  type="text"
                  formControlName="firstName"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-neutral-700 dark:text-neutral-300 bg-neutral-100 dark:bg-neutral-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
              </div>
              <div>
                <label class="block text-neutral-700 dark:text-neutral-300 text-sm font-bold mb-2">Last Name</label>
                <input
                  type="text"
                  formControlName="lastName"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-neutral-700 dark:text-neutral-300 bg-neutral-100 dark:bg-neutral-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
              </div>
              <div class="col-span-2">
                <label class="block text-neutral-700 dark:text-neutral-300 text-sm font-bold mb-2">Email</label>
                <input
                  type="email"
                  formControlName="email"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-neutral-700 dark:text-neutral-300 bg-neutral-100 dark:bg-neutral-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
              </div>
              <div class="col-span-2">
                <label class="block text-neutral-700 dark:text-neutral-300 text-sm font-bold mb-2">Phone</label>
                <input
                  type="tel"
                  formControlName="phone"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-neutral-700 dark:text-neutral-300 bg-neutral-100 dark:bg-neutral-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
              </div>
              <div class="col-span-2 flex justify-end space-x-4">
                <button
                  type="button"
                  (click)="toggleEdit()"
                  class="secondary-button"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="primary-button"
                  [disabled]="profileForm.invalid"
                >
                  Save Changes
                </button>
              </div>
            </div>
          </form>

          <!-- Edit Profile Button -->
          <div *ngIf="!isEditing" class="mt-4">
            <button
              (click)="toggleEdit()"
              class="primary-button"
            >
              Edit Profile
            </button>
          </div>
        </div>

        <!-- User Type Specific Content -->
        <ng-container *ngIf="user">
          <!-- Client Specific Details -->
          <div *ngIf="isClient(user)" class="bg-neutral-100 dark:bg-neutral-800 rounded-lg shadow-md p-8 mb-8">
            <h2 class="text-2xl font-bold mb-4 text-neutral-800 dark:text-neutral-100">Client Details</h2>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Client Type:</strong> {{ user.clientType }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>ID Type:</strong> {{ user.idType }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>ID Number:</strong> {{ user.idNumber }}</p>

            <div class="mt-4">
              <h3 class="text-xl font-semibold mb-2 text-neutral-800 dark:text-neutral-100">Financial Information</h3>
              <p class="text-neutral-700 dark:text-neutral-300"><strong>Account Balance:</strong> {{ user.balance | currency }}</p>
              <button
                (click)="viewTransactions()"
                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded mt-2 transition duration-300 ease-in-out"
              >
                View Transactions
              </button>
            </div>
          </div>

          <!-- Agent Specific Details -->
          <div *ngIf="isAgent(user)" class="bg-neutral-100 dark:bg-neutral-800 rounded-lg shadow-md p-8 mb-8">
            <h2 class="text-2xl font-bold mb-4 text-neutral-800 dark:text-neutral-100">Agent Details</h2>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>ID Type:</strong> {{ user.idType }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>ID Number:</strong> {{ user.idNumber }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Birthdate:</strong> {{ user.birthdate }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Address:</strong> {{ user.address }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Immatriculation:</strong> {{ user.immatriculation }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Patent Number:</strong> {{ user.patentNumber }}</p>
          </div>

          <!-- Admin Specific Details -->
          <div *ngIf="isAdmin(user)" class="bg-neutral-100 dark:bg-neutral-800 rounded-lg shadow-md p-8 mb-8">
            <h2 class="text-2xl font-bold mb-4 text-neutral-800 dark:text-neutral-100">Admin Details</h2>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Admin Level:</strong> {{ user.adminLevel }}</p>
            <p class="text-neutral-700 dark:text-neutral-300"><strong>Department:</strong> {{ user.department }}</p>
          </div>
        </ng-container>

        <!-- Change Password Section -->
        <div class="bg-white dark:bg-neutral-800 rounded-lg shadow-md p-8 mb-8">
          <h2 class="text-2xl font-bold mb-4 text-neutral-800 dark:text-neutral-100">Change Password</h2>

          <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="grid grid-cols-1 gap-4">
            <div>
              <label class="block text-neutral-700 dark:text-neutral-300 text-sm font-bold mb-2">Current Password</label>
              <input
                type="password"
                formControlName="currentPassword"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-neutral-700 dark:text-neutral-300 bg-neutral-100 dark:bg-neutral-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <p *ngIf="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched"
                 class="text-red-500 text-xs italic">
                Current password is required
              </p>
            </div>

            <div>
              <label class="block text-neutral-700 dark:text-neutral-300 text-sm font-bold mb-2">New Password</label>
              <input
                type="password"
                formControlName="newPassword"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-neutral-700 dark:text-neutral-300 bg-neutral-100 dark:bg-neutral-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <p *ngIf="passwordForm.get('newPassword')?.errors?.['minlength'] && passwordForm.get('newPassword')?.touched"
                 class="text-red-500 text-xs italic">
                Password must be at least 8 characters long
              </p>
            </div>

            <div>
              <label class="block text-neutral-700 dark:text-neutral-300 text-sm font-bold mb-2">Confirm New Password</label>
              <input
                type="password"
                formControlName="confirmNewPassword"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-neutral-700 dark:text-neutral-300 bg-neutral-100 dark:bg-neutral-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <p *ngIf="passwordForm.errors?.['passwordMismatch'] && passwordForm.get('confirmNewPassword')?.touched"
                 class="text-red-500 text-xs italic">
                Passwords do not match
              </p>
            </div>

            <div>
              <button
                type="submit"
                [disabled]="passwordForm.invalid"
                class="primary-button"
              >
                Change Password
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>
</div>

